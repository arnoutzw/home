<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Involute Gear Generator</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#09090b">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="icon" type="image/svg+xml" href="icon.svg">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script>
  tailwind.config = { theme: { extend: { fontFamily: { sans: ['Inter','sans-serif'], mono: ['JetBrains Mono','monospace'] } } } }
  </script>
  <style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; overflow: hidden; }
  ::-webkit-scrollbar { width: 8px; }
  ::-webkit-scrollbar-track { background: #18181b; }
  ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }
  input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 6px; background: #27272a; border-radius: 3px; outline: none; }
  input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: #f59e0b; border-radius: 50%; cursor: pointer; box-shadow: 0 0 0 3px rgba(245,158,11,0.15); }
  .toggle { position: relative; width: 32px; height: 20px; background: #3f3f46; border-radius: 9999px; cursor: pointer; transition: background 0.2s; flex-shrink: 0; }
  .toggle.active { background: #f59e0b; }
  .toggle::after { content: ''; position: absolute; top: 2px; left: 2px; width: 16px; height: 16px; background: #fff; border-radius: 50%; transition: transform 0.2s; }
  .toggle.active::after { transform: translateX(12px); }
  .warn { display: none; margin-top: 10px; padding: 8px 10px; border-radius: 8px; font-size: 11px; line-height: 1.4; align-items: flex-start; gap: 6px; }
  .warn.show { display: flex; }
  .warn-orange { background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.3); color: #f59e0b; }
  .warn-red { background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); color: #ef4444; }
  #toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(80px); transition: transform 0.3s ease; }
  #toast.show { transform: translateX(-50%) translateY(0); }
  #viewport:active { cursor: grabbing; }
  .mode-btn { transition: all 0.15s; }
  .mode-btn.active { background: #f59e0b; color: #18181b; }
  @media (max-width: 800px) { #sidebar { width: 300px !important; min-width: 300px !important; } }
  </style>
</head>
<body class="font-sans bg-zinc-950 text-zinc-100">
<div id="app" class="flex h-screen">
  <aside id="sidebar" class="w-[360px] min-w-[360px] bg-zinc-900 border-r border-zinc-700 flex flex-col overflow-y-auto overflow-x-hidden">

    <!-- Logo -->
    <div class="px-5 pt-4 pb-4 border-b border-zinc-700">
      <div class="flex gap-1.5 mb-3">
        <div class="w-3 h-3 rounded-full bg-red-500"></div>
        <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
        <div class="w-3 h-3 rounded-full bg-green-500"></div>
      </div>
      <div class="flex items-center gap-3">
        <svg viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 flex-shrink-0">
          <circle cx="256" cy="256" r="240" fill="#09090b"/>
          <path d="M256 56 l20 50 l50-15 l-5 52 l50 12 l-30 43 l40 33 l-48 22 l22 48 l-52-3 l3 52 l-50-22 l-20 50 l-20-50 l-50 22 l3-52 l-52 3 l22-48 l-48-22 l40-33 l-30-43 l50-12 l-5-52 l50 15 Z" fill="#f59e0b" fill-opacity="0.9" stroke="#f59e0b" stroke-width="2"/>
          <circle cx="256" cy="256" r="85" fill="#09090b"/>
          <circle cx="256" cy="256" r="28" fill="#18181b" stroke="#3f3f46" stroke-width="3"/>
        </svg>
        <div>
          <h1 class="font-mono font-bold text-amber-500 text-[15px] tracking-tight leading-tight">Involute Gear Generator</h1>
          <span class="text-xs text-zinc-500 font-mono">DXF / SVG export for CAD &amp; CNC</span>
        </div>
      </div>
    </div>

    <!-- Mode Switch -->
    <div class="px-5 pt-4 pb-3 border-b border-zinc-700">
      <div class="flex bg-zinc-800 rounded-lg p-1 gap-1">
        <button id="mode-single" class="mode-btn active flex-1 py-1.5 text-xs font-mono font-bold rounded-md text-center cursor-pointer">Single</button>
        <button id="mode-pair" class="mode-btn flex-1 py-1.5 text-xs font-mono font-bold rounded-md text-center cursor-pointer text-zinc-400 hover:text-zinc-200">Pair</button>
        <button id="mode-planetary" class="mode-btn flex-1 py-1.5 text-xs font-mono font-bold rounded-md text-center cursor-pointer text-zinc-400 hover:text-zinc-200">Planetary</button>
      </div>
    </div>

    <!-- Gear 1 Parameters -->
    <div class="p-5 border-b border-zinc-700">
      <div class="flex items-center justify-between mb-3.5">
        <span class="text-xs font-bold uppercase tracking-widest text-zinc-500 font-mono" id="g1-title">Gear Parameters</span>
        <span class="text-xs px-2 py-0.5 bg-amber-500/10 text-amber-400 rounded font-mono">Spur</span>
      </div>
      <div class="mb-3">
        <div class="flex justify-between items-center mb-1.5">
          <span class="text-sm font-medium">Module (mm)</span>
          <span class="font-mono text-xs font-medium text-amber-500 bg-amber-500/10 px-2 py-0.5 rounded min-w-[52px] text-center" id="v-mod">2.0</span>
        </div>
        <div class="flex items-center gap-2.5">
          <input type="range" id="r-mod" min="0.3" max="12" step="0.1" value="2" class="flex-1">
          <input type="number" id="n-mod" min="0.1" max="50" step="0.1" value="2" class="w-[72px] px-1.5 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-100 font-mono text-xs text-center outline-none focus:border-amber-500">
        </div>
      </div>
      <div class="mb-3">
        <div class="flex justify-between items-center mb-1.5">
          <span class="text-sm font-medium">Number of Teeth</span>
          <span class="font-mono text-xs font-medium text-amber-500 bg-amber-500/10 px-2 py-0.5 rounded min-w-[52px] text-center" id="v-teeth">24</span>
        </div>
        <div class="flex items-center gap-2.5">
          <input type="range" id="r-teeth" min="6" max="200" step="1" value="24" class="flex-1">
          <input type="number" id="n-teeth" min="4" max="500" step="1" value="24" class="w-[72px] px-1.5 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-100 font-mono text-xs text-center outline-none focus:border-amber-500">
        </div>
      </div>
      <div class="mb-3">
        <div class="flex justify-between items-center mb-1.5">
          <span class="text-sm font-medium">Pressure Angle</span>
        </div>
        <select id="s-pa" class="w-full px-4 py-2.5 bg-zinc-800 border border-zinc-700 rounded-lg text-zinc-100 text-sm font-mono outline-none cursor-pointer focus:border-amber-500">
          <option value="14.5">14.5 (legacy / clocks)</option>
          <option value="20" selected>20 (standard)</option>
          <option value="25">25 (high load)</option>
        </select>
      </div>
      <div class="mb-3">
        <div class="flex justify-between items-center mb-1.5">
          <span class="text-sm font-medium">Profile Shift (x)</span>
          <span class="font-mono text-xs font-medium text-amber-500 bg-amber-500/10 px-2 py-0.5 rounded min-w-[52px] text-center" id="v-ps">0.00</span>
        </div>
        <div class="flex items-center gap-2.5">
          <input type="range" id="r-ps" min="-0.6" max="0.6" step="0.01" value="0" class="flex-1">
          <input type="number" id="n-ps" min="-1" max="1" step="0.01" value="0" class="w-[72px] px-1.5 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-100 font-mono text-xs text-center outline-none focus:border-amber-500">
        </div>
      </div>
      <div class="mb-3">
        <div class="flex justify-between items-center mb-1.5">
          <span class="text-sm font-medium">Bore Diameter (mm)</span>
          <span class="font-mono text-xs font-medium text-amber-500 bg-amber-500/10 px-2 py-0.5 rounded min-w-[52px] text-center" id="v-bore">8.0</span>
        </div>
        <div class="flex items-center gap-2.5">
          <input type="range" id="r-bore" min="0" max="200" step="0.5" value="8" class="flex-1">
          <input type="number" id="n-bore" min="0" max="500" step="0.1" value="8" class="w-[72px] px-1.5 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-100 font-mono text-xs text-center outline-none focus:border-amber-500">
        </div>
      </div>
      <div class="mb-3">
        <div class="flex justify-between items-center mb-1.5">
          <span class="text-sm font-medium">Clearance Coeff.</span>
          <span class="font-mono text-xs font-medium text-amber-500 bg-amber-500/10 px-2 py-0.5 rounded min-w-[52px] text-center" id="v-cl">0.25</span>
        </div>
        <div class="flex items-center gap-2.5">
          <input type="range" id="r-cl" min="0.1" max="0.4" step="0.01" value="0.25" class="flex-1">
          <input type="number" id="n-cl" min="0" max="1" step="0.01" value="0.25" class="w-[72px] px-1.5 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-100 font-mono text-xs text-center outline-none focus:border-amber-500">
        </div>
      </div>
      <div>
        <div class="flex justify-between items-center mb-1.5">
          <span class="text-sm font-medium">Profile Resolution</span>
          <span class="font-mono text-xs font-medium text-amber-500 bg-amber-500/10 px-2 py-0.5 rounded min-w-[52px] text-center" id="v-res">40</span>
        </div>
        <div class="flex items-center gap-2.5">
          <input type="range" id="r-res" min="10" max="100" step="5" value="40" class="flex-1">
          <input type="number" id="n-res" min="5" max="200" step="1" value="40" class="w-[72px] px-1.5 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-100 font-mono text-xs text-center outline-none focus:border-amber-500">
        </div>
      </div>
      <div id="warn-undercut" class="warn warn-orange">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="flex-shrink-0 mt-0.5"><path d="M12 9v4m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/></svg>
        <span id="warn-text"></span>
      </div>
    </div>

    <!-- Gear 2 Parameters (hidden by default) -->
    <div id="gear2-section" class="p-5 border-b border-zinc-700" style="display:none">
      <div class="flex items-center justify-between mb-3.5">
        <span class="text-xs font-bold uppercase tracking-widest text-zinc-500 font-mono">Gear 2</span>
        <span class="text-xs px-2 py-0.5 bg-cyan-500/10 text-cyan-400 rounded font-mono">Driven</span>
      </div>
      <div class="mb-3">
        <div class="flex justify-between items-center mb-1.5">
          <span class="text-sm font-medium">Number of Teeth</span>
          <span class="font-mono text-xs font-medium text-cyan-400 bg-cyan-500/10 px-2 py-0.5 rounded min-w-[52px] text-center" id="v-teeth2">36</span>
        </div>
        <div class="flex items-center gap-2.5">
          <input type="range" id="r-teeth2" min="6" max="200" step="1" value="36" class="flex-1">
          <input type="number" id="n-teeth2" min="4" max="500" step="1" value="36" class="w-[72px] px-1.5 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-100 font-mono text-xs text-center outline-none focus:border-cyan-400">
        </div>
      </div>
      <div class="mb-3">
        <div class="flex justify-between items-center mb-1.5">
          <span class="text-sm font-medium">Profile Shift (x)</span>
          <span class="font-mono text-xs font-medium text-cyan-400 bg-cyan-500/10 px-2 py-0.5 rounded min-w-[52px] text-center" id="v-ps2">0.00</span>
        </div>
        <div class="flex items-center gap-2.5">
          <input type="range" id="r-ps2" min="-0.6" max="0.6" step="0.01" value="0" class="flex-1">
          <input type="number" id="n-ps2" min="-1" max="1" step="0.01" value="0" class="w-[72px] px-1.5 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-100 font-mono text-xs text-center outline-none focus:border-cyan-400">
        </div>
      </div>
      <div>
        <div class="flex justify-between items-center mb-1.5">
          <span class="text-sm font-medium">Bore Diameter (mm)</span>
          <span class="font-mono text-xs font-medium text-cyan-400 bg-cyan-500/10 px-2 py-0.5 rounded min-w-[52px] text-center" id="v-bore2">12.0</span>
        </div>
        <div class="flex items-center gap-2.5">
          <input type="range" id="r-bore2" min="0" max="200" step="0.5" value="12" class="flex-1">
          <input type="number" id="n-bore2" min="0" max="500" step="0.1" value="12" class="w-[72px] px-1.5 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-100 font-mono text-xs text-center outline-none focus:border-cyan-400">
        </div>
      </div>
    </div>

    <!-- Planetary Parameters (hidden by default) -->
    <div id="planetary-section" class="p-5 border-b border-zinc-700" style="display:none">
      <div class="flex items-center justify-between mb-3.5">
        <span class="text-xs font-bold uppercase tracking-widest text-zinc-500 font-mono">Planetary Set</span>
        <span class="text-xs px-2 py-0.5 bg-emerald-500/10 text-emerald-400 rounded font-mono">Epicyclic</span>
      </div>
      <div class="mb-3">
        <div class="flex justify-between items-center mb-1.5">
          <span class="text-sm font-medium">Sun Teeth</span>
          <span class="font-mono text-xs font-medium text-amber-500 bg-amber-500/10 px-2 py-0.5 rounded min-w-[52px] text-center" id="v-sunz">20</span>
        </div>
        <div class="flex items-center gap-2.5">
          <input type="range" id="r-sunz" min="8" max="100" step="1" value="20" class="flex-1">
          <input type="number" id="n-sunz" min="6" max="200" step="1" value="20" class="w-[72px] px-1.5 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-100 font-mono text-xs text-center outline-none focus:border-amber-500">
        </div>
      </div>
      <div class="mb-3">
        <div class="flex justify-between items-center mb-1.5">
          <span class="text-sm font-medium">Planet Teeth</span>
          <span class="font-mono text-xs font-medium text-cyan-400 bg-cyan-500/10 px-2 py-0.5 rounded min-w-[52px] text-center" id="v-planz">10</span>
        </div>
        <div class="flex items-center gap-2.5">
          <input type="range" id="r-planz" min="6" max="100" step="1" value="10" class="flex-1">
          <input type="number" id="n-planz" min="6" max="200" step="1" value="10" class="w-[72px] px-1.5 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-100 font-mono text-xs text-center outline-none focus:border-cyan-400">
        </div>
      </div>
      <div class="mb-3">
        <div class="flex justify-between items-center mb-1.5">
          <span class="text-sm font-medium">Number of Planets</span>
          <span class="font-mono text-xs font-medium text-emerald-400 bg-emerald-500/10 px-2 py-0.5 rounded min-w-[52px] text-center" id="v-nplan">3</span>
        </div>
        <div class="flex items-center gap-2.5">
          <input type="range" id="r-nplan" min="2" max="8" step="1" value="3" class="flex-1">
          <input type="number" id="n-nplan" min="2" max="8" step="1" value="3" class="w-[72px] px-1.5 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-100 font-mono text-xs text-center outline-none focus:border-emerald-400">
        </div>
      </div>
      <div class="mb-3">
        <div class="flex justify-between items-center mb-1.5">
          <span class="text-sm font-medium">Ring Teeth (auto)</span>
          <span class="font-mono text-xs font-medium text-rose-400 bg-rose-500/10 px-2 py-0.5 rounded min-w-[52px] text-center" id="v-ringz">40</span>
        </div>
      </div>
      <div class="mb-3">
        <div class="flex justify-between items-center mb-1.5">
          <span class="text-sm font-medium">Sun Bore (mm)</span>
          <span class="font-mono text-xs font-medium text-amber-500 bg-amber-500/10 px-2 py-0.5 rounded min-w-[52px] text-center" id="v-sunbore">6.0</span>
        </div>
        <div class="flex items-center gap-2.5">
          <input type="range" id="r-sunbore" min="0" max="100" step="0.5" value="6" class="flex-1">
          <input type="number" id="n-sunbore" min="0" max="200" step="0.1" value="6" class="w-[72px] px-1.5 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-100 font-mono text-xs text-center outline-none focus:border-amber-500">
        </div>
      </div>
      <div>
        <div class="flex justify-between items-center mb-1.5">
          <span class="text-sm font-medium">Planet Bore (mm)</span>
          <span class="font-mono text-xs font-medium text-cyan-400 bg-cyan-500/10 px-2 py-0.5 rounded min-w-[52px] text-center" id="v-planbore">4.0</span>
        </div>
        <div class="flex items-center gap-2.5">
          <input type="range" id="r-planbore" min="0" max="100" step="0.5" value="4" class="flex-1">
          <input type="number" id="n-planbore" min="0" max="200" step="0.1" value="4" class="w-[72px] px-1.5 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-100 font-mono text-xs text-center outline-none focus:border-amber-500">
        </div>
      </div>
      <div id="warn-planetary" class="warn warn-orange">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="flex-shrink-0 mt-0.5"><path d="M12 9v4m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/></svg>
        <span id="warn-plan-text"></span>
      </div>
    </div>

    <!-- Display -->
    <div class="p-5 border-b border-zinc-700">
      <div class="flex items-center justify-between mb-3.5">
        <span class="text-xs font-bold uppercase tracking-widest text-zinc-500 font-mono">Display</span>
      </div>
      <div class="flex items-center gap-2.5 mb-3"><div class="toggle active" id="t-pitch" data-key="showPitch"></div><label class="text-sm font-medium cursor-pointer text-zinc-300">Pitch circle</label></div>
      <div class="flex items-center gap-2.5 mb-3"><div class="toggle active" id="t-base" data-key="showBase"></div><label class="text-sm font-medium cursor-pointer text-zinc-300">Base circle</label></div>
      <div class="flex items-center gap-2.5 mb-3"><div class="toggle" id="t-root" data-key="showRoot"></div><label class="text-sm font-medium cursor-pointer text-zinc-300">Root circle</label></div>
      <div class="flex items-center gap-2.5 mb-3"><div class="toggle" id="t-outer" data-key="showOuter"></div><label class="text-sm font-medium cursor-pointer text-zinc-300">Addendum circle</label></div>
      <div class="flex items-center gap-2.5"><div class="toggle active" id="t-dims" data-key="showDims"></div><label class="text-sm font-medium cursor-pointer text-zinc-300">Dimension labels</label></div>
    </div>

    <!-- Computed Values -->
    <div class="p-5 border-b border-zinc-700">
      <div class="flex items-center justify-between mb-3.5">
        <span class="text-xs font-bold uppercase tracking-widest text-zinc-500 font-mono">Computed Values</span>
      </div>
      <div class="grid grid-cols-2 gap-x-3.5 gap-y-1.5">
        <div class="flex justify-between items-center py-1 text-xs"><span class="text-zinc-500">Pitch Dia.</span><span class="font-mono text-xs font-medium" id="i-pd">--</span></div>
        <div class="flex justify-between items-center py-1 text-xs"><span class="text-zinc-500">Outside Dia.</span><span class="font-mono text-xs font-medium" id="i-od">--</span></div>
        <div class="flex justify-between items-center py-1 text-xs"><span class="text-zinc-500">Root Dia.</span><span class="font-mono text-xs font-medium" id="i-rd">--</span></div>
        <div class="flex justify-between items-center py-1 text-xs"><span class="text-zinc-500">Base Dia.</span><span class="font-mono text-xs font-medium" id="i-bd">--</span></div>
        <div class="flex justify-between items-center py-1 text-xs"><span class="text-zinc-500">Circ. Pitch</span><span class="font-mono text-xs font-medium" id="i-cp">--</span></div>
        <div class="flex justify-between items-center py-1 text-xs"><span class="text-zinc-500">Tooth Thk.</span><span class="font-mono text-xs font-medium" id="i-tt">--</span></div>
        <div class="flex justify-between items-center py-1 text-xs"><span class="text-zinc-500">Addendum</span><span class="font-mono text-xs font-medium" id="i-ha">--</span></div>
        <div class="flex justify-between items-center py-1 text-xs"><span class="text-zinc-500">Dedendum</span><span class="font-mono text-xs font-medium" id="i-hf">--</span></div>
        <div class="flex justify-between items-center py-1 text-xs"><span class="text-zinc-500">Total Points</span><span class="font-mono text-xs font-medium" id="i-np">--</span></div>
        <div class="flex justify-between items-center py-1 text-xs"><span class="text-zinc-500">Undercut</span><span class="font-mono text-xs font-medium" id="i-uc">--</span></div>
      </div>
      <!-- Pair-mode info -->
      <div id="pair-info" class="mt-3 pt-3 border-t border-zinc-700/50 grid grid-cols-2 gap-x-3.5 gap-y-1.5" style="display:none">
        <div class="flex justify-between items-center py-1 text-xs"><span class="text-cyan-600">G2 Pitch Dia.</span><span class="font-mono text-xs font-medium text-cyan-400" id="i-pd2">--</span></div>
        <div class="flex justify-between items-center py-1 text-xs"><span class="text-cyan-600">G2 Outside Dia.</span><span class="font-mono text-xs font-medium text-cyan-400" id="i-od2">--</span></div>
        <div class="flex justify-between items-center py-1 text-xs col-span-2"><span class="text-zinc-500">Center Distance</span><span class="font-mono text-xs font-bold text-amber-400" id="i-cd">--</span></div>
        <div class="flex justify-between items-center py-1 text-xs"><span class="text-zinc-500">Gear Ratio</span><span class="font-mono text-xs font-medium" id="i-gr">--</span></div>
        <div class="flex justify-between items-center py-1 text-xs"><span class="text-zinc-500">Speed Ratio</span><span class="font-mono text-xs font-medium" id="i-sr">--</span></div>
      </div>
      <!-- Planetary-mode info -->
      <div id="planetary-info" class="mt-3 pt-3 border-t border-zinc-700/50 grid grid-cols-2 gap-x-3.5 gap-y-1.5" style="display:none">
        <div class="flex justify-between items-center py-1 text-xs"><span class="text-amber-600">Sun Pitch Dia.</span><span class="font-mono text-xs font-medium text-amber-400" id="i-spd">--</span></div>
        <div class="flex justify-between items-center py-1 text-xs"><span class="text-cyan-600">Planet Pitch Dia.</span><span class="font-mono text-xs font-medium text-cyan-400" id="i-ppd">--</span></div>
        <div class="flex justify-between items-center py-1 text-xs"><span class="text-rose-600">Ring Pitch Dia.</span><span class="font-mono text-xs font-medium text-rose-400" id="i-rpd">--</span></div>
        <div class="flex justify-between items-center py-1 text-xs"><span class="text-zinc-500">Center Distance</span><span class="font-mono text-xs font-bold text-amber-400" id="i-pcd">--</span></div>
        <div class="flex justify-between items-center py-1 text-xs"><span class="text-zinc-500">Overall Ratio</span><span class="font-mono text-xs font-bold text-emerald-400" id="i-ratio">--</span></div>
        <div class="flex justify-between items-center py-1 text-xs"><span class="text-zinc-500">Ring Teeth</span><span class="font-mono text-xs font-medium text-rose-400" id="i-rtz">--</span></div>
        <div class="flex justify-between items-center py-1 text-xs col-span-2"><span class="text-zinc-500">Assembly</span><span class="font-mono text-xs font-medium" id="i-asm">--</span></div>
      </div>
    </div>

    <!-- Export -->
    <div class="p-5 mt-auto border-t border-zinc-700">
      <div class="flex items-center justify-between mb-3.5">
        <span class="text-xs font-bold uppercase tracking-widest text-zinc-500 font-mono">Export</span>
      </div>
      <div class="grid grid-cols-2 gap-2">
        <button class="bg-amber-500 hover:bg-amber-400 text-zinc-900 font-mono font-bold px-4 py-2.5 rounded-lg col-span-2 flex items-center justify-center gap-2 transition-colors active:scale-[0.97]" id="btn-dxf">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          Export DXF
        </button>
        <button class="bg-zinc-700 hover:bg-zinc-600 text-zinc-300 text-xs font-mono px-3 py-1.5 rounded-lg flex items-center justify-center gap-2 transition-colors active:scale-[0.97]" id="btn-svg">SVG</button>
        <button class="bg-zinc-800 hover:bg-zinc-700 text-zinc-300 text-xs font-mono px-3 py-1.5 rounded-lg border border-zinc-700 flex items-center justify-center gap-2 transition-colors active:scale-[0.97]" id="btn-png">PNG</button>
      </div>
    </div>
  </aside>

  <main id="viewport" class="flex-1 relative bg-zinc-950 cursor-grab">
    <canvas id="gearCanvas" class="block"></canvas>
    <div class="absolute top-4 left-4 z-10 text-xs text-zinc-500 font-mono bg-zinc-950/85 px-2.5 py-1.5 rounded-lg pointer-events-none" id="canvasInfo">Zoom: 100%</div>
    <div class="absolute top-4 right-4 z-10 bg-zinc-950/90 px-3.5 py-2.5 rounded-lg border border-zinc-700 text-xs font-mono" id="canvasLegend">
      <div class="flex items-center gap-2 mb-1"><div class="w-2.5 h-0.5 rounded-sm bg-zinc-100"></div><span class="text-zinc-500">Gear 1</span></div>
      <div id="legend-g2" class="flex items-center gap-2 mb-1" style="display:none"><div class="w-2.5 h-0.5 rounded-sm bg-cyan-400"></div><span class="text-zinc-500">Gear 2</span></div>
      <div id="legend-sun" class="flex items-center gap-2 mb-1" style="display:none"><div class="w-2.5 h-0.5 rounded-sm bg-amber-400"></div><span class="text-zinc-500">Sun</span></div>
      <div id="legend-planet" class="flex items-center gap-2 mb-1" style="display:none"><div class="w-2.5 h-0.5 rounded-sm bg-cyan-400"></div><span class="text-zinc-500">Planets</span></div>
      <div id="legend-ring" class="flex items-center gap-2 mb-1" style="display:none"><div class="w-2.5 h-0.5 rounded-sm bg-rose-400"></div><span class="text-zinc-500">Ring</span></div>
      <div id="legend-carrier" class="flex items-center gap-2 mb-1" style="display:none"><div class="w-2.5 h-0.5 rounded-sm bg-emerald-400"></div><span class="text-zinc-500">Carrier</span></div>
      <div class="flex items-center gap-2 mb-1"><div class="w-2.5 h-0.5 rounded-sm bg-amber-500 opacity-60"></div><span class="text-zinc-500">Pitch circle</span></div>
      <div class="flex items-center gap-2"><div class="w-2.5 h-0.5 rounded-sm bg-blue-500 opacity-60"></div><span class="text-zinc-500">Base circle</span></div>
    </div>
    <!-- Animation panel -->
    <div id="anim-panel" class="absolute bottom-4 left-4 z-10 flex items-center gap-3 bg-zinc-900/95 border border-zinc-700 rounded-lg px-3 py-2" style="display:none">
      <button id="btn-play" class="w-9 h-9 rounded-full bg-amber-500 hover:bg-amber-400 text-zinc-900 flex items-center justify-center cursor-pointer transition-colors flex-shrink-0">
        <svg id="icon-play" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><polygon points="6 3 20 12 6 21"/></svg>
        <svg id="icon-pause" width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="display:none"><rect x="5" y="3" width="4" height="18"/><rect x="15" y="3" width="4" height="18"/></svg>
      </button>
      <input type="range" id="r-speed" min="0.1" max="5" step="0.1" value="1" class="w-24">
      <span class="font-mono text-xs text-zinc-400 min-w-[36px]" id="v-speed">1.0x</span>
    </div>
    <!-- Zoom controls -->
    <div class="absolute bottom-4 right-4 flex gap-1.5 z-10">
      <button class="w-9 h-9 border border-zinc-700 bg-zinc-900 rounded-lg text-zinc-400 cursor-pointer flex items-center justify-center transition-all hover:bg-zinc-800 hover:text-zinc-100" id="btn-zoomfit" title="Zoom to fit"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 3v18M3 9h18"/></svg></button>
      <button class="w-9 h-9 border border-zinc-700 bg-zinc-900 rounded-lg text-zinc-400 cursor-pointer flex items-center justify-center transition-all hover:bg-zinc-800 hover:text-zinc-100" id="btn-zoomin" title="Zoom in"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button>
      <button class="w-9 h-9 border border-zinc-700 bg-zinc-900 rounded-lg text-zinc-400 cursor-pointer flex items-center justify-center transition-all hover:bg-zinc-800 hover:text-zinc-100" id="btn-zoomout" title="Zoom out"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/></svg></button>
    </div>
  </main>
</div>
<div id="toast" class="px-5 py-2.5 bg-zinc-800 border border-zinc-700 rounded-xl text-sm font-mono z-[200] pointer-events-none whitespace-nowrap shadow-lg text-zinc-100"></div>

<script>
/* ═══════════════════════════════════════════════════════════════
   INVOLUTE GEAR MATH
   ═══════════════════════════════════════════════════════════════ */
const GearMath = {
  generate(p) {
    const { module: m, teeth: z, pressureAngleDeg: paDeg, profileShift: x, clearance: c, resolution: res } = p;
    const alpha = paDeg * Math.PI / 180;
    const inv = a => Math.tan(a) - a;
    const rp = m * z / 2, rb = rp * Math.cos(alpha);
    const ra = rp + m * (1 + x), rf = Math.max(rp - m * (1 + c - x), 0.1);
    const toothThk = m * (Math.PI / 2 + 2 * x * Math.tan(alpha));
    const halfA = toothThk / (2 * rp), invA = inv(alpha);
    const angP = 2 * Math.PI / z, startR = Math.max(rb, rf);
    const minZ = Math.ceil(2 / (Math.sin(alpha) ** 2));
    const hasUndercut = z < minZ && x < (minZ - z) / (2 * minZ);

    const rAng = (tc, r) => r <= rb ? tc + halfA + invA : tc + halfA + invA - inv(Math.acos(Math.min(rb / r, 1)));
    const lAng = (tc, r) => r <= rb ? tc - halfA - invA : tc - halfA - invA + inv(Math.acos(Math.min(rb / r, 1)));

    const pts = [], rootN = Math.max(4, Math.round(res / 4)), tipN = Math.max(3, Math.round(res / 5)), trN = 4;
    for (let i = 0; i < z; i++) {
      const tc = i * angP;
      if (rf < rb) { const ba = rAng(tc, rb); for (let j = 0; j <= trN; j++) { const r = rf + (j / trN) * (rb - rf); pts.push([r * Math.cos(ba), r * Math.sin(ba)]); } }
      for (let j = 0; j <= res; j++) { const r = startR + (j / res) * (ra - startR); const a = rAng(tc, r); pts.push([r * Math.cos(a), r * Math.sin(a)]); }
      const rT = rAng(tc, ra), lT = lAng(tc, ra);
      for (let j = 1; j < tipN; j++) { const a = rT + (j / tipN) * (lT - rT); pts.push([ra * Math.cos(a), ra * Math.sin(a)]); }
      for (let j = 0; j <= res; j++) { const r = ra - (j / res) * (ra - startR); const a = lAng(tc, r); pts.push([r * Math.cos(a), r * Math.sin(a)]); }
      if (rf < rb) { const ba = lAng(tc, rb); for (let j = 1; j <= trN; j++) { const r = rb - (j / trN) * (rb - rf); pts.push([r * Math.cos(ba), r * Math.sin(ba)]); } }
      const gs = rf < rb ? lAng(tc, rb) : lAng(tc, startR);
      const ge = rf < rb ? rAng((i + 1) * angP, rb) : rAng((i + 1) * angP, startR);
      for (let j = 1; j <= rootN; j++) { const a = gs + (j / rootN) * (ge - gs); pts.push([rf * Math.cos(a), rf * Math.sin(a)]); }
    }
    const cl = [pts[0]];
    for (let i = 1; i < pts.length; i++) { const dx = pts[i][0] - cl[cl.length - 1][0], dy = pts[i][1] - cl[cl.length - 1][1]; if (dx * dx + dy * dy > 1e-12) cl.push(pts[i]); }
    if (cl.length > 2) { const dx = cl[cl.length - 1][0] - cl[0][0], dy = cl[cl.length - 1][1] - cl[0][1]; if (dx * dx + dy * dy < 1e-10) cl.pop(); }
    return { points: cl, radii: { pitch: rp, base: rb, addendum: ra, root: rf },
      info: { pitchDia: 2 * rp, outerDia: 2 * ra, rootDia: 2 * rf, baseDia: 2 * rb, circPitch: Math.PI * m, toothThk, addendum: m * (1 + x), dedendum: m * (1 + c - x), hasUndercut, minTeethNoUndercut: minZ } };
  }
};

/* ═══════════════════════════════════════════════════════════════
   INTERNAL (RING) GEAR MATH
   ═══════════════════════════════════════════════════════════════ */
const RingGearMath = {
  generate(p) {
    const { module: m, teeth: z, pressureAngleDeg: paDeg, clearance: c, resolution: res } = p;
    const alpha = paDeg * Math.PI / 180;
    const inv = a => Math.tan(a) - a;
    const rp = m * z / 2, rb = rp * Math.cos(alpha);
    // Internal gear: addendum goes inward, dedendum goes outward
    const ra = rp - m;          // tip of internal teeth (inward)
    const rf = rp + m * (1 + c); // root of internal teeth (outward)
    const toothThk = m * Math.PI / 2;
    const halfA = toothThk / (2 * rp), invA = inv(alpha);
    const angP = 2 * Math.PI / z;
    const startR = Math.max(rb, ra);

    // Internal gear: involute curves OPPOSITE direction from external
    // As r increases outward from rb, angle INCREASES for right flank (opposite of external)
    const rAng = (tc, r) => r <= rb ? tc + halfA : tc + halfA - invA + inv(Math.acos(Math.min(rb / r, 1)));
    const lAng = (tc, r) => r <= rb ? tc - halfA : tc - halfA + invA - inv(Math.acos(Math.min(rb / r, 1)));

    const pts = [], rootN = Math.max(4, Math.round(res / 4)), tipN = Math.max(3, Math.round(res / 5));
    for (let i = 0; i < z; i++) {
      const tc = i * angP;
      // Right involute: from rf (root/outer) inward to rb
      for (let j = 0; j <= res; j++) {
        const r = rf - (j / res) * (rf - rb);
        const a = rAng(tc, r);
        pts.push([r * Math.cos(a), r * Math.sin(a)]);
      }
      // Radial line from rb inward to ra (tip)
      if (ra < rb) {
        const ba = rAng(tc, rb);
        for (let j = 1; j <= 3; j++) { const r = rb - (j / 3) * (rb - ra); pts.push([r * Math.cos(ba), r * Math.sin(ba)]); }
      }
      // Tip arc at ra (inner tip of internal tooth)
      const tipR = Math.min(ra, rb);
      const rT = ra < rb ? rAng(tc, rb) : rAng(tc, rb);
      const lT = ra < rb ? lAng(tc, rb) : lAng(tc, rb);
      for (let j = 1; j < tipN; j++) { const a = rT + (j / tipN) * (lT - rT); pts.push([tipR * Math.cos(a), tipR * Math.sin(a)]); }
      // Radial line from ra back outward to rb
      if (ra < rb) {
        const ba2 = lAng(tc, rb);
        for (let j = 1; j <= 3; j++) { const r = ra + (j / 3) * (rb - ra); pts.push([r * Math.cos(ba2), r * Math.sin(ba2)]); }
      }
      // Left involute: from rb outward to rf (root)
      for (let j = 0; j <= res; j++) {
        const r = rb + (j / res) * (rf - rb);
        const a = lAng(tc, r);
        pts.push([r * Math.cos(a), r * Math.sin(a)]);
      }
      // Root arc at rf (outer), from left flank to next right flank
      const gs = lAng(tc, rf);
      const ge = rAng((i + 1) * angP, rf);
      for (let j = 1; j <= rootN; j++) { const a = gs + (j / rootN) * (ge - gs); pts.push([rf * Math.cos(a), rf * Math.sin(a)]); }
    }
    const cl = [pts[0]];
    for (let i = 1; i < pts.length; i++) { const dx = pts[i][0] - cl[cl.length - 1][0], dy = pts[i][1] - cl[cl.length - 1][1]; if (dx * dx + dy * dy > 1e-12) cl.push(pts[i]); }
    if (cl.length > 2) { const dx = cl[cl.length - 1][0] - cl[0][0], dy = cl[cl.length - 1][1] - cl[0][1]; if (dx * dx + dy * dy < 1e-10) cl.pop(); }
    return { points: cl, radii: { pitch: rp, base: rb, addendum: ra, root: rf },
      info: { pitchDia: 2 * rp, innerDia: 2 * ra, outerDia: 2 * rf, baseDia: 2 * rb } };
  }
};

/* ═══════════════════════════════════════════════════════════════
   TRANSFORM HELPERS
   ═══════════════════════════════════════════════════════════════ */
function transformPts(pts, angle, tx, ty) {
  const c = Math.cos(angle), s = Math.sin(angle);
  return pts.map(([x, y]) => [x * c - y * s + tx, x * s + y * c + ty]);
}

/* ═══════════════════════════════════════════════════════════════
   DXF EXPORT
   ═══════════════════════════════════════════════════════════════ */
const DXFExport = {
  generate(gear1pts, bore1, radii1, gear2pts, bore2, radii2, cd) {
    const L = [], w = s => L.push(s);
    w('0');w('SECTION');w('2');w('HEADER');w('9');w('$ACADVER');w('1');w('AC1015');w('9');w('$INSUNITS');w('70');w('4');w('9');w('$MEASUREMENT');w('70');w('1');w('0');w('ENDSEC');
    w('0');w('SECTION');w('2');w('TABLES');w('0');w('TABLE');w('2');w('LAYER');w('70');w('6');
    const addLayer = (name, color) => { w('0');w('LAYER');w('2');w(name);w('70');w('0');w('62');w(String(color));w('6');w('CONTINUOUS'); };
    addLayer('GEAR_1', 7); addLayer('GEAR_2', 4); addLayer('BORE', 1); addLayer('PITCH_CIRCLE', 3); addLayer('BASE_CIRCLE', 5); addLayer('CENTER_LINE', 2);
    w('0');w('ENDTAB');w('0');w('ENDSEC');
    w('0');w('SECTION');w('2');w('ENTITIES');
    const writePoly = (pts, layer) => { w('0');w('LWPOLYLINE');w('8');w(layer);w('90');w(String(pts.length));w('70');w('1'); for (const [x, y] of pts) { w('10');w(x.toFixed(6));w('20');w(y.toFixed(6)); } };
    const writeCircle = (cx, cy, r, layer) => { w('0');w('CIRCLE');w('8');w(layer);w('10');w(cx.toFixed(6));w('20');w(cy.toFixed(6));w('40');w(r.toFixed(6)); };
    writePoly(gear1pts, 'GEAR_1');
    if (bore1 > 0) writeCircle(0, 0, bore1 / 2, 'BORE');
    writeCircle(0, 0, radii1.pitch, 'PITCH_CIRCLE');
    writeCircle(0, 0, radii1.base, 'BASE_CIRCLE');
    if (gear2pts) {
      writePoly(gear2pts, 'GEAR_2');
      if (bore2 > 0) writeCircle(cd, 0, bore2 / 2, 'BORE');
      writeCircle(cd, 0, radii2.pitch, 'PITCH_CIRCLE');
      writeCircle(cd, 0, radii2.base, 'BASE_CIRCLE');
      // center line
      w('0');w('LINE');w('8');w('CENTER_LINE');w('10');w('0');w('20');w('0');w('11');w(cd.toFixed(6));w('21');w('0');
    }
    w('0');w('ENDSEC');w('0');w('EOF');
    return L.join('\n');
  }
};

/* ═══════════════════════════════════════════════════════════════
   SVG EXPORT
   ═══════════════════════════════════════════════════════════════ */
const SVGExport = {
  generate(g1pts, bore1, radii1, g2pts, bore2, radii2, cd) {
    const margin = 5;
    const ra1 = radii1.addendum, ra2 = radii2 ? radii2.addendum : 0;
    const left = -ra1 - margin, top_ = -Math.max(ra1, ra2) - margin;
    const right = (cd || 0) + Math.max(ra1, ra2) + margin;
    const bottom = Math.max(ra1, ra2) + margin;
    const vw = right - left, vh = bottom - top_;
    const ptsToD = pts => { let d = `M ${pts[0][0].toFixed(6)},${(-pts[0][1]).toFixed(6)}`; for (let i = 1; i < pts.length; i++) d += ` L ${pts[i][0].toFixed(6)},${(-pts[i][1]).toFixed(6)}`; return d + ' Z'; };
    let s = `<?xml version="1.0" encoding="UTF-8"?>\n<svg xmlns="http://www.w3.org/2000/svg" width="${vw.toFixed(2)}mm" height="${vh.toFixed(2)}mm" viewBox="${left.toFixed(4)} ${top_.toFixed(4)} ${vw.toFixed(4)} ${vh.toFixed(4)}">\n`;
    s += `<path d="${ptsToD(g1pts)}" fill="none" stroke="#000" stroke-width="0.2"/>\n`;
    if (bore1 > 0) s += `<circle cx="0" cy="0" r="${(bore1 / 2).toFixed(6)}" fill="none" stroke="#000" stroke-width="0.2"/>\n`;
    s += `<circle cx="0" cy="0" r="${radii1.pitch.toFixed(6)}" fill="none" stroke="#888" stroke-width="0.1" stroke-dasharray="1,1"/>\n`;
    if (g2pts) {
      s += `<path d="${ptsToD(g2pts)}" fill="none" stroke="#0088cc" stroke-width="0.2"/>\n`;
      if (bore2 > 0) s += `<circle cx="${cd.toFixed(6)}" cy="0" r="${(bore2 / 2).toFixed(6)}" fill="none" stroke="#0088cc" stroke-width="0.2"/>\n`;
      s += `<circle cx="${cd.toFixed(6)}" cy="0" r="${radii2.pitch.toFixed(6)}" fill="none" stroke="#888" stroke-width="0.1" stroke-dasharray="1,1"/>\n`;
    }
    s += `</svg>`; return s;
  }
};

/* ═══════════════════════════════════════════════════════════════
   CANVAS RENDERER (with animation support)
   ═══════════════════════════════════════════════════════════════ */
const Renderer = (() => {
  let canvas, ctx;
  let panX = 0, panY = 0, zoom = 1, isDrag = false, lastM = { x: 0, y: 0 };
  let dOpts = { showPitch: true, showBase: true, showRoot: false, showOuter: false, showDims: true };
  const D = () => Math.min(window.devicePixelRatio || 1, 2);

  // Gear state
  let pairMode = false, planetaryMode = false;
  let g1 = null, g2 = null; // { points, radii, bore }
  let centerDist = 0, z1 = 24, z2 = 36;
  let g1Angle = 0, phase2 = 0;
  let isPlaying = false, animSpeed = 1, animId = null, lastTime = null;
  // Planetary state
  let sunGear = null, planetGear = null, ringGear = null;
  let sunZ = 20, planZ = 10, ringZ = 40, nPlanets = 3, planCD = 0;
  let sunAngle = 0, sunBore = 6, planBore = 4;

  function init(c) { canvas = c; ctx = c.getContext('2d'); resize(); bindEv(); }
  function resize() { const p = canvas.parentElement, w = p.clientWidth, h = p.clientHeight, d = D(); canvas.width = w * d; canvas.height = h * d; canvas.style.width = w + 'px'; canvas.style.height = h + 'px'; draw(); }
  function toS(wx, wy) { const d = D(), cx = canvas.width / (2 * d), cy = canvas.height / (2 * d); return [(wx * zoom + panX + cx) * d, (-wy * zoom + panY + cy) * d]; }
  function toW(sx, sy) { const d = D(), cx = canvas.width / (2 * d), cy = canvas.height / (2 * d); return [(sx / d - panX - cx) / zoom, -(sy / d - panY - cy) / zoom]; }

  function setGear(gear, bore) { pairMode = false; planetaryMode = false; g1 = { points: gear.points, radii: gear.radii, bore }; g2 = null; z1 = 0; stopAnim(); draw(); }

  function setGearPair(gear1, bore1, gear2, bore2, cd, teeth1, teeth2) {
    pairMode = true; planetaryMode = false;
    g1 = { points: gear1.points, radii: gear1.radii, bore: bore1 };
    g2 = { points: gear2.points, radii: gear2.radii, bore: bore2 };
    centerDist = cd; z1 = teeth1; z2 = teeth2;
    phase2 = Math.PI - Math.PI / z2;
    draw();
  }

  function setPlanetary(sun, planet, ring, cd, sz, pz, rz, np, sBore, pBore) {
    planetaryMode = true; pairMode = false;
    sunGear = sun; planetGear = planet; ringGear = ring;
    planCD = cd; sunZ = sz; planZ = pz; ringZ = rz; nPlanets = np;
    sunBore = sBore; planBore = pBore;
    sunAngle = 0;
    draw();
  }

  function play() { if (isPlaying) return; isPlaying = true; lastTime = null; animId = requestAnimationFrame(animate); }
  function pause() { isPlaying = false; if (animId) { cancelAnimationFrame(animId); animId = null; } }
  function stopAnim() { pause(); g1Angle = 0; }
  function setSpeed(s) { animSpeed = s; }

  function animate(ts) {
    if (!lastTime) lastTime = ts;
    const dt = Math.min((ts - lastTime) / 1000, 0.05);
    lastTime = ts;
    if (planetaryMode) { sunAngle += 0.6 * animSpeed * dt; }
    else { g1Angle += 0.6 * animSpeed * dt; }
    draw();
    if (isPlaying) animId = requestAnimationFrame(animate);
  }

  function draw() {
    if (!canvas) return;
    const d = D(), w = canvas.width, h = canvas.height;
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    ctx.clearRect(0, 0, w, h);
    ctx.fillStyle = '#09090b';
    ctx.fillRect(0, 0, w, h);
    drawGrid();
    if (planetaryMode && sunGear) drawPlanetary();
    else if (pairMode && g1 && g2) drawPair();
    else if (g1) drawSingle();
    updateInfo();
  }

  function drawSingle() {
    const d = D(), { points, radii: r, bore } = g1;
    drawRefCircles(r, 0, 0);
    drawProfile(points, 0, 0, 0, 'rgba(244,244,245,0.85)', 'rgba(244,244,245,0.04)');
    if (bore > 0) drawBore(bore, 0, 0, 'rgba(244,244,245,0.6)');
    if (dOpts.showDims) drawDimLabels(r, 0, 0, '');
  }

  function drawPair() {
    const d = D();
    const angle2 = phase2 - g1Angle * z1 / z2;

    // Line of centers
    const [lx1, ly1] = toS(0, 0), [lx2, ly2] = toS(centerDist, 0);
    ctx.strokeStyle = 'rgba(161,161,170,0.15)';
    ctx.lineWidth = 1 * D();
    ctx.setLineDash([6 * D(), 4 * D()]);
    ctx.beginPath(); ctx.moveTo(lx1, ly1); ctx.lineTo(lx2, ly2); ctx.stroke();
    ctx.setLineDash([]);

    // Pitch point
    const pitchPt = g1.radii.pitch;
    const [ppx, ppy] = toS(pitchPt, 0);
    ctx.fillStyle = 'rgba(245,158,11,0.6)';
    ctx.beginPath(); ctx.arc(ppx, ppy, 3 * D(), 0, Math.PI * 2); ctx.fill();

    // Reference circles
    drawRefCircles(g1.radii, 0, 0);
    drawRefCircles(g2.radii, centerDist, 0);

    // Gear profiles with rotation
    drawProfile(g1.points, 0, 0, g1Angle, 'rgba(244,244,245,0.85)', 'rgba(244,244,245,0.04)');
    drawProfile(g2.points, centerDist, 0, angle2, 'rgba(34,211,238,0.8)', 'rgba(34,211,238,0.03)');

    // Bores
    if (g1.bore > 0) drawBore(g1.bore, 0, 0, 'rgba(244,244,245,0.5)');
    if (g2.bore > 0) drawBore(g2.bore, centerDist, 0, 'rgba(34,211,238,0.5)');

    // Center dots
    const [c1x, c1y] = toS(0, 0), [c2x, c2y] = toS(centerDist, 0);
    ctx.fillStyle = 'rgba(244,244,245,0.4)';
    ctx.beginPath(); ctx.arc(c1x, c1y, 2.5 * D(), 0, Math.PI * 2); ctx.fill();
    ctx.fillStyle = 'rgba(34,211,238,0.4)';
    ctx.beginPath(); ctx.arc(c2x, c2y, 2.5 * D(), 0, Math.PI * 2); ctx.fill();

    if (dOpts.showDims) {
      drawDimLabels(g1.radii, 0, 0, 'G1 ');
      drawDimLabels(g2.radii, centerDist, 0, 'G2 ');
    }
  }

  function drawPlanetary() {
    const d = D();
    // Kinematics: ring fixed, sun input, carrier output
    const carrierAngle = sunAngle * sunZ / (sunZ + ringZ);
    // Planet spin RELATIVE to carrier (sun drives planet in opposite direction)
    const planetRelSpin = -(sunAngle - carrierAngle) * sunZ / planZ;

    // Draw ring gear (static, with outer housing)
    const [rcx, rcy] = toS(0, 0);
    const housingR = (ringGear.radii.root + 2 * (ringGear.radii.root - ringGear.radii.pitch)) * zoom * d;
    ctx.strokeStyle = 'rgba(251,113,133,0.3)'; ctx.lineWidth = 2 * d;
    ctx.beginPath(); ctx.arc(rcx, rcy, housingR, 0, Math.PI * 2); ctx.stroke();
    drawProfile(ringGear.points, 0, 0, 0, 'rgba(251,113,133,0.7)', 'rgba(251,113,133,0.02)');

    // Draw carrier circle
    ctx.strokeStyle = 'rgba(52,211,153,0.35)'; ctx.lineWidth = 1.5 * d;
    ctx.setLineDash([8 * d, 4 * d]);
    ctx.beginPath(); ctx.arc(rcx, rcy, planCD * zoom * d, 0, Math.PI * 2); ctx.stroke();
    ctx.setLineDash([]);

    // Draw carrier arms
    for (let i = 0; i < nPlanets; i++) {
      const angle = carrierAngle + (2 * Math.PI * i) / nPlanets;
      const px = planCD * Math.cos(angle), py = planCD * Math.sin(angle);
      const [sx, sy] = toS(0, 0), [ex, ey] = toS(px, py);
      ctx.strokeStyle = 'rgba(52,211,153,0.25)'; ctx.lineWidth = 3 * d;
      ctx.beginPath(); ctx.moveTo(sx, sy); ctx.lineTo(ex, ey); ctx.stroke();
    }

    // Draw planets with correct meshing
    for (let i = 0; i < nPlanets; i++) {
      const orbitAngle = carrierAngle + (2 * Math.PI * i) / nPlanets;
      const px = planCD * Math.cos(orbitAngle), py = planCD * Math.sin(orbitAngle);
      // Meshing phase: gap faces sun (angle π from planet center toward origin)
      // Per-planet offset accounts for different sun tooth at each orbit position
      const meshPhase = Math.PI - Math.PI / planZ - (2 * Math.PI * i / nPlanets) * sunZ / planZ;
      const pAngle = meshPhase + carrierAngle + planetRelSpin;
      drawProfile(planetGear.points, px, py, pAngle, 'rgba(34,211,238,0.8)', 'rgba(34,211,238,0.03)');
      if (planBore > 0) drawBore(planBore, px, py, 'rgba(34,211,238,0.5)');
      // Planet center dot
      const [pcx, pcy] = toS(px, py);
      ctx.fillStyle = 'rgba(34,211,238,0.4)';
      ctx.beginPath(); ctx.arc(pcx, pcy, 2.5 * d, 0, Math.PI * 2); ctx.fill();
    }

    // Draw sun gear (rotating)
    drawProfile(sunGear.points, 0, 0, sunAngle, 'rgba(251,191,36,0.9)', 'rgba(251,191,36,0.04)');
    if (sunBore > 0) drawBore(sunBore, 0, 0, 'rgba(251,191,36,0.5)');

    // Reference circles
    if (dOpts.showPitch) {
      const circ = (rad, ox, oy, col) => {
        const [ccx, ccy] = toS(ox, oy);
        ctx.strokeStyle = col; ctx.lineWidth = 1 * d;
        ctx.setLineDash([6 * d, 3 * d]);
        ctx.beginPath(); ctx.arc(ccx, ccy, rad * zoom * d, 0, Math.PI * 2); ctx.stroke();
        ctx.setLineDash([]);
      };
      circ(sunGear.radii.pitch, 0, 0, 'rgba(245,158,11,0.35)');
      circ(ringGear.radii.pitch, 0, 0, 'rgba(251,113,133,0.25)');
    }

    // Sun center dot
    const [scx, scy] = toS(0, 0);
    ctx.fillStyle = 'rgba(251,191,36,0.5)';
    ctx.beginPath(); ctx.arc(scx, scy, 3 * d, 0, Math.PI * 2); ctx.fill();
  }

  function drawProfile(pts, ox, oy, angle, stroke, fill) {
    const d = D(), cos = Math.cos(angle), sin = Math.sin(angle);
    ctx.beginPath();
    for (let i = 0; i < pts.length; i++) {
      const [x, y] = pts[i];
      const rx = x * cos - y * sin + ox, ry = x * sin + y * cos + oy;
      const [sx, sy] = toS(rx, ry);
      if (i === 0) ctx.moveTo(sx, sy); else ctx.lineTo(sx, sy);
    }
    ctx.closePath();
    ctx.fillStyle = fill; ctx.fill();
    ctx.strokeStyle = stroke; ctx.lineWidth = 1.5 * d; ctx.stroke();
  }

  function drawBore(bore, ox, oy, color) {
    const [cx, cy] = toS(ox, oy);
    ctx.strokeStyle = color; ctx.lineWidth = 1.2 * D();
    ctx.beginPath(); ctx.arc(cx, cy, bore / 2 * zoom * D(), 0, Math.PI * 2); ctx.stroke();
  }

  function drawRefCircles(r, ox, oy) {
    const d = D();
    const circ = (rad, col, dash) => {
      const [cx, cy] = toS(ox, oy);
      ctx.strokeStyle = col; ctx.lineWidth = 1 * d;
      ctx.setLineDash(dash.map(v => v * d));
      ctx.beginPath(); ctx.arc(cx, cy, rad * zoom * d, 0, Math.PI * 2); ctx.stroke();
      ctx.setLineDash([]);
    };
    if (dOpts.showRoot) circ(r.root, 'rgba(239,68,68,0.35)', [4, 3]);
    if (dOpts.showBase) circ(r.base, 'rgba(59,130,246,0.4)', [3, 3]);
    if (dOpts.showPitch) circ(r.pitch, 'rgba(245,158,11,0.45)', [6, 3]);
    if (dOpts.showOuter) circ(r.addendum, 'rgba(167,139,250,0.35)', [4, 3]);
  }

  function drawDimLabels(r, ox, oy, prefix) {
    const d = D(), la = Math.PI * 0.28;
    const dimL = (rad, lbl, col) => {
      const [lx, ly] = toS(ox + rad * Math.cos(la), rad * Math.sin(la));
      ctx.font = `500 ${10 * d}px Inter,sans-serif`; ctx.fillStyle = col;
      ctx.textAlign = 'left'; ctx.textBaseline = 'bottom';
      ctx.fillText(prefix + lbl + ' \u2300' + (2 * rad).toFixed(2), lx + 5 * d, ly - 3 * d);
    };
    if (dOpts.showPitch) dimL(r.pitch, 'PD', 'rgba(245,158,11,0.65)');
    if (dOpts.showBase) dimL(r.base, 'BD', 'rgba(59,130,246,0.55)');
    if (dOpts.showRoot) dimL(r.root, 'RD', 'rgba(239,68,68,0.55)');
    if (dOpts.showOuter) dimL(r.addendum, 'OD', 'rgba(167,139,250,0.55)');
  }

  function drawGrid() {
    const d = D(), w = canvas.width / d, h = canvas.height / d;
    const raw = 50 / zoom, mag = Math.pow(10, Math.floor(Math.log10(raw))), norm = raw / mag;
    let sp; if (norm < 2) sp = mag; else if (norm < 5) sp = 2 * mag; else sp = 5 * mag;
    const mSp = sp / 5;
    const [wx0, wy0] = toW(0, 0), [wx1, wy1] = toW(w * d, h * d);
    const mnX = Math.min(wx0, wx1), mxX = Math.max(wx0, wx1), mnY = Math.min(wy0, wy1), mxY = Math.max(wy0, wy1);
    if (mSp * zoom > 4) {
      ctx.strokeStyle = 'rgba(63,63,70,0.3)'; ctx.lineWidth = 0.5 * d; ctx.beginPath();
      for (let x = Math.floor(mnX / mSp) * mSp; x <= mxX; x += mSp) { const [sx] = toS(x, 0); ctx.moveTo(sx, 0); ctx.lineTo(sx, h * d); }
      for (let y = Math.floor(mnY / mSp) * mSp; y <= mxY; y += mSp) { const [, sy] = toS(0, y); ctx.moveTo(0, sy); ctx.lineTo(w * d, sy); }
      ctx.stroke();
    }
    ctx.strokeStyle = 'rgba(63,63,70,0.7)'; ctx.lineWidth = 0.8 * d; ctx.beginPath();
    for (let x = Math.floor(mnX / sp) * sp; x <= mxX; x += sp) { const [sx] = toS(x, 0); ctx.moveTo(sx, 0); ctx.lineTo(sx, h * d); }
    for (let y = Math.floor(mnY / sp) * sp; y <= mxY; y += sp) { const [, sy] = toS(0, y); ctx.moveTo(0, sy); ctx.lineTo(w * d, sy); }
    ctx.stroke();
    const [ox, oy] = toS(0, 0);
    ctx.strokeStyle = 'rgba(161,161,170,0.3)'; ctx.lineWidth = 1 * d; ctx.beginPath();
    ctx.moveTo(ox, 0); ctx.lineTo(ox, h * d); ctx.moveTo(0, oy); ctx.lineTo(w * d, oy); ctx.stroke();
    ctx.fillStyle = 'rgba(161,161,170,0.5)'; ctx.beginPath(); ctx.arc(ox, oy, 3 * d, 0, Math.PI * 2); ctx.fill();
    if (dOpts.showDims) {
      ctx.font = `${10 * d}px Inter,sans-serif`; ctx.fillStyle = 'rgba(161,161,170,0.5)';
      ctx.textAlign = 'left'; ctx.textBaseline = 'top';
      for (let x = Math.floor(mnX / sp) * sp; x <= mxX; x += sp) { if (Math.abs(x) < sp * 0.01) continue; const [sx] = toS(x, 0); ctx.fillText(fmtN(x), sx + 3 * d, oy + 4 * d); }
      ctx.textAlign = 'right'; ctx.textBaseline = 'middle';
      for (let y = Math.floor(mnY / sp) * sp; y <= mxY; y += sp) { if (Math.abs(y) < sp * 0.01) continue; const [, sy] = toS(0, y); ctx.fillText(fmtN(y), ox - 4 * d, sy); }
    }
  }
  function fmtN(v) { return Math.abs(v) >= 1 ? Number(v.toFixed(1)).toString() : v.toFixed(2); }
  function updateInfo() { document.getElementById('canvasInfo').textContent = 'Zoom: ' + (zoom * 100).toFixed(0) + '%'; }

  function zoomToFit() {
    if (!g1 && !sunGear) return;
    const d = D(), w = canvas.width / d, h = canvas.height / d, pad = 60;
    if (planetaryMode && ringGear) {
      const outerR = ringGear.radii.root;
      zoom = Math.min((w - pad) / (2 * outerR), (h - pad) / (2 * outerR));
      panX = 0; panY = 0;
    } else if (pairMode && g2) {
      const maxR = Math.max(g1.radii.addendum, g2.radii.addendum);
      const totalW = centerDist + 2 * maxR, totalH = 2 * maxR;
      zoom = Math.min((w - pad) / totalW, (h - pad) / totalH);
      panX = -centerDist / 2 * zoom;
      panY = 0;
    } else if (g1) {
      const ra = g1.radii.addendum;
      zoom = Math.min((w - pad) / (2 * ra), (h - pad) / (2 * ra));
      panX = 0; panY = 0;
    }
    draw();
  }

  function bindEv() {
    canvas.addEventListener('wheel', e => {
      e.preventDefault();
      const f = e.deltaY > 0 ? 0.9 : 1.1, d = D(), rect = canvas.getBoundingClientRect();
      const mx = e.clientX - rect.left, my = e.clientY - rect.top;
      const cx = canvas.width / (2 * d), cy = canvas.height / (2 * d);
      const wx = (mx - panX - cx) / zoom, wy = -(my - panY - cy) / zoom;
      zoom *= f; zoom = Math.max(0.01, Math.min(zoom, 500));
      panX = mx - cx - wx * zoom; panY = my - cy + wy * zoom;
      draw();
    }, { passive: false });
    canvas.addEventListener('mousedown', e => { isDrag = true; lastM = { x: e.clientX, y: e.clientY }; });
    window.addEventListener('mousemove', e => { if (!isDrag) return; panX += e.clientX - lastM.x; panY += e.clientY - lastM.y; lastM = { x: e.clientX, y: e.clientY }; draw(); });
    window.addEventListener('mouseup', () => { isDrag = false; });
    let ltd = null;
    canvas.addEventListener('touchstart', e => { if (e.touches.length === 1) { isDrag = true; lastM = { x: e.touches[0].clientX, y: e.touches[0].clientY }; } else if (e.touches.length === 2) { isDrag = false; const dx = e.touches[0].clientX - e.touches[1].clientX, dy = e.touches[0].clientY - e.touches[1].clientY; ltd = Math.sqrt(dx * dx + dy * dy); } e.preventDefault(); }, { passive: false });
    canvas.addEventListener('touchmove', e => { if (e.touches.length === 1 && isDrag) { panX += e.touches[0].clientX - lastM.x; panY += e.touches[0].clientY - lastM.y; lastM = { x: e.touches[0].clientX, y: e.touches[0].clientY }; draw(); } else if (e.touches.length === 2 && ltd !== null) { const dx = e.touches[0].clientX - e.touches[1].clientX, dy = e.touches[0].clientY - e.touches[1].clientY; const dist = Math.sqrt(dx * dx + dy * dy); zoom *= dist / ltd; zoom = Math.max(0.01, Math.min(zoom, 500)); ltd = dist; draw(); } e.preventDefault(); }, { passive: false });
    canvas.addEventListener('touchend', () => { isDrag = false; ltd = null; });
    window.addEventListener('resize', resize);
  }

  return {
    init, setGear, setGearPair, setPlanetary, setDisplayOpt: (k, v) => { dOpts[k] = v; draw(); },
    zoomToFit, zoomIn() { zoom *= 1.3; draw(); }, zoomOut() { zoom *= 0.77; draw(); },
    play, pause, stopAnim, setSpeed, isPlaying: () => isPlaying,
    draw, resize, getCanvas: () => canvas,
    getState: () => ({ pairMode, planetaryMode, g1, g2, centerDist, phase2, sunGear, planetGear, ringGear })
  };
})();

/* ═══════════════════════════════════════════════════════════════
   APP CONTROLLER
   ═══════════════════════════════════════════════════════════════ */
(function() {
  const $ = s => document.querySelector(s);
  let result1 = null, result2 = null, params = {}, pairMode = false, planetaryMode = false;
  let sunResult = null, planetResult = null, ringResult = null;

  function toast(m) { const e = $('#toast'); e.textContent = m; e.classList.add('show'); setTimeout(() => e.classList.remove('show'), 2500); }
  function dl(c, fn, mime) { const b = typeof c === 'string' ? new Blob([c], { type: mime }) : c; const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href = u; a.download = fn; document.body.appendChild(a); a.click(); setTimeout(() => { URL.revokeObjectURL(u); a.remove(); }, 100); }
  function bindCtl(rId, nId, vId, fmt, cb) {
    const r = $(rId), n = $(nId), v = $(vId);
    function sync(src) { const val = parseFloat(src.value); if (isNaN(val)) return; if (src === r) n.value = val; else r.value = Math.max(r.min, Math.min(r.max, val)); v.textContent = fmt(val); (cb || updateGear)(); }
    r.addEventListener('input', () => sync(r)); n.addEventListener('input', () => sync(n)); n.addEventListener('change', () => sync(n));
  }

  function readP() {
    return {
      module: parseFloat($('#n-mod').value) || 2, teeth: parseInt($('#n-teeth').value) || 24,
      pressureAngleDeg: parseFloat($('#s-pa').value), profileShift: parseFloat($('#n-ps').value) || 0,
      bore: parseFloat($('#n-bore').value) || 0, clearance: parseFloat($('#n-cl').value) || 0.25,
      resolution: parseInt($('#n-res').value) || 40,
      teeth2: parseInt($('#n-teeth2').value) || 36, profileShift2: parseFloat($('#n-ps2').value) || 0,
      bore2: parseFloat($('#n-bore2').value) || 0,
      sunTeeth: parseInt($('#n-sunz').value) || 20, planetTeeth: parseInt($('#n-planz').value) || 10,
      nPlanets: parseInt($('#n-nplan').value) || 3,
      sunBore: parseFloat($('#n-sunbore').value) || 0, planetBore: parseFloat($('#n-planbore').value) || 0
    };
  }

  function updateGear() {
    params = readP();
    const { module: m, teeth: z, pressureAngleDeg: pa, profileShift: x, bore, clearance: c, resolution: res } = params;

    // Generate gear 1
    result1 = GearMath.generate({ module: m, teeth: z, pressureAngleDeg: pa, profileShift: x, clearance: c, resolution: res });
    const { info: info1, points: pts1 } = result1;

    // Update G1 computed values
    const mm = v => v.toFixed(3);
    $('#i-pd').textContent = mm(info1.pitchDia); $('#i-od').textContent = mm(info1.outerDia);
    $('#i-rd').textContent = mm(info1.rootDia); $('#i-bd').textContent = mm(info1.baseDia);
    $('#i-cp').textContent = mm(info1.circPitch); $('#i-tt').textContent = mm(info1.toothThk);
    $('#i-ha').textContent = mm(info1.addendum); $('#i-hf').textContent = mm(info1.dedendum);
    $('#i-np').textContent = pts1.length;
    $('#i-uc').textContent = info1.hasUndercut ? 'Yes' : 'No';
    $('#i-uc').style.color = info1.hasUndercut ? '#ef4444' : '#22c55e';

    // Warnings
    const rp = m * z / 2, rf = Math.max(rp - m * (1 + c - x), 0.1);
    const warn = $('#warn-undercut'), wt = $('#warn-text');
    if (info1.toothThk <= 0) { wt.textContent = 'Tooth thickness is zero or negative.'; warn.className = 'warn warn-red show'; }
    else if (info1.hasUndercut) { wt.textContent = 'Undercut: min ' + info1.minTeethNoUndercut + ' teeth needed, or increase profile shift.'; warn.className = 'warn warn-orange show'; }
    else { warn.classList.remove('show'); }

    if (planetaryMode) {
      const { sunTeeth: sz, planetTeeth: pz, nPlanets: np, sunBore: sb, planetBore: pb } = params;
      const rz = sz + 2 * pz; // ring teeth = sun + 2*planet
      const cd = m * (sz + pz) / 2;
      const assembly = (sz + rz) % np === 0;

      // Generate sun gear (use main gear params for module/PA/clearance/res)
      sunResult = GearMath.generate({ module: m, teeth: sz, pressureAngleDeg: pa, profileShift: 0, clearance: c, resolution: res });
      planetResult = GearMath.generate({ module: m, teeth: pz, pressureAngleDeg: pa, profileShift: 0, clearance: c, resolution: res });
      ringResult = RingGearMath.generate({ module: m, teeth: rz, pressureAngleDeg: pa, clearance: c, resolution: res });

      // Update display values
      $('#v-ringz').textContent = rz;
      $('#i-spd').textContent = mm(sunResult.info.pitchDia);
      $('#i-ppd').textContent = mm(planetResult.info.pitchDia);
      $('#i-rpd').textContent = mm(ringResult.info.pitchDia);
      $('#i-pcd').textContent = mm(cd);
      const overallRatio = 1 + rz / sz;
      $('#i-ratio').textContent = overallRatio.toFixed(3) + ':1';
      $('#i-rtz').textContent = rz;
      $('#i-asm').textContent = assembly ? 'Valid' : 'Invalid spacing';
      $('#i-asm').style.color = assembly ? '#22c55e' : '#ef4444';

      // Update G1 computed values for sun gear
      const sInfo = sunResult.info;
      $('#i-pd').textContent = mm(sInfo.pitchDia); $('#i-od').textContent = mm(sInfo.outerDia);
      $('#i-rd').textContent = mm(sInfo.rootDia); $('#i-bd').textContent = mm(sInfo.baseDia);

      // Warnings
      const warnP = $('#warn-planetary'), wtP = $('#warn-plan-text');
      if (!assembly) { wtP.textContent = `Assembly constraint failed: (${sz}+${rz}) mod ${np} = ${(sz + rz) % np}. Planets won't space evenly.`; warnP.className = 'warn warn-red show'; }
      else if (pz < 6) { wtP.textContent = 'Very few planet teeth may cause interference.'; warnP.className = 'warn warn-orange show'; }
      else { warnP.classList.remove('show'); }

      Renderer.setPlanetary(sunResult, planetResult, ringResult, cd, sz, pz, rz, np, sb, pb);
    } else if (pairMode) {
      const { teeth2: z2, profileShift2: x2, bore2 } = params;
      result2 = GearMath.generate({ module: m, teeth: z2, pressureAngleDeg: pa, profileShift: x2, clearance: c, resolution: res });
      const info2 = result2.info;
      const cd = m * (z + z2) / 2 + m * (x + x2);

      // Update pair info
      $('#i-pd2').textContent = mm(info2.pitchDia); $('#i-od2').textContent = mm(info2.outerDia);
      $('#i-cd').textContent = mm(cd);
      const g = gcd(z, z2);
      $('#i-gr').textContent = (z / g) + ':' + (z2 / g);
      $('#i-sr').textContent = (z2 / z).toFixed(3) + 'x';

      // Transform gear 2 for DXF/SVG export (static mesh position)
      const phase2 = Math.PI - Math.PI / z2;
      Renderer.setGearPair(result1, params.bore, result2, params.bore2, cd, z, z2);
    } else {
      result2 = null;
      Renderer.setGear(result1, params.bore);
    }
  }

  function gcd(a, b) { a = Math.abs(a); b = Math.abs(b); while (b) { [a, b] = [b, a % b]; } return a; }

  function setMode(mode) {
    pairMode = mode === 'pair';
    planetaryMode = mode === 'planetary';
    // Update mode buttons
    ['single', 'pair', 'planetary'].forEach(m => {
      const btn = $(`#mode-${m}`);
      btn.classList.toggle('active', m === mode);
      btn.classList.toggle('text-zinc-400', m !== mode);
    });
    // Show/hide sections
    $('#gear2-section').style.display = pairMode ? '' : 'none';
    $('#planetary-section').style.display = planetaryMode ? '' : 'none';
    $('#pair-info').style.display = pairMode ? '' : 'none';
    $('#planetary-info').style.display = planetaryMode ? '' : 'none';
    $('#anim-panel').style.display = (pairMode || planetaryMode) ? '' : 'none';
    // Legend
    $('#legend-g2').style.display = pairMode ? '' : 'none';
    ['sun', 'planet', 'ring', 'carrier'].forEach(k => {
      $(`#legend-${k}`).style.display = planetaryMode ? '' : 'none';
    });
    // Title
    $('#g1-title').textContent = pairMode ? 'Gear 1' : planetaryMode ? 'Base Parameters' : 'Gear Parameters';
    if (mode === 'single') { Renderer.stopAnim(); updatePlayBtn(false); }
    updateGear();
    requestAnimationFrame(() => Renderer.zoomToFit());
  }

  function updatePlayBtn(playing) {
    $('#icon-play').style.display = playing ? 'none' : '';
    $('#icon-pause').style.display = playing ? '' : 'none';
  }

  function generatePlanetaryDXF() {
    const m = params.module, sz = params.sunTeeth, pz = params.planetTeeth, np = params.nPlanets;
    const rz = sz + 2 * pz, cd = m * (sz + pz) / 2;
    const L = [], w = s => L.push(s);
    w('0');w('SECTION');w('2');w('HEADER');w('9');w('$ACADVER');w('1');w('AC1015');w('9');w('$INSUNITS');w('70');w('4');w('9');w('$MEASUREMENT');w('70');w('1');w('0');w('ENDSEC');
    w('0');w('SECTION');w('2');w('TABLES');w('0');w('TABLE');w('2');w('LAYER');w('70');w('10');
    const addLayer = (name, color) => { w('0');w('LAYER');w('2');w(name);w('70');w('0');w('62');w(String(color));w('6');w('CONTINUOUS'); };
    addLayer('SUN_GEAR', 2); addLayer('PLANET_GEAR', 4); addLayer('RING_GEAR', 1);
    addLayer('BORE', 7); addLayer('PITCH_CIRCLE', 3); addLayer('CARRIER', 3);
    w('0');w('ENDTAB');w('0');w('ENDSEC');
    w('0');w('SECTION');w('2');w('ENTITIES');
    const writePoly = (pts, layer) => { w('0');w('LWPOLYLINE');w('8');w(layer);w('90');w(String(pts.length));w('70');w('1'); for (const [x, y] of pts) { w('10');w(x.toFixed(6));w('20');w(y.toFixed(6)); } };
    const writeCircle = (cx, cy, r, layer) => { w('0');w('CIRCLE');w('8');w(layer);w('10');w(cx.toFixed(6));w('20');w(cy.toFixed(6));w('40');w(r.toFixed(6)); };
    // Sun
    writePoly(sunResult.points, 'SUN_GEAR');
    if (params.sunBore > 0) writeCircle(0, 0, params.sunBore / 2, 'BORE');
    writeCircle(0, 0, sunResult.radii.pitch, 'PITCH_CIRCLE');
    // Ring
    writePoly(ringResult.points, 'RING_GEAR');
    writeCircle(0, 0, ringResult.radii.pitch, 'PITCH_CIRCLE');
    // Planets (positioned at assembly angles)
    for (let i = 0; i < np; i++) {
      const angle = (2 * Math.PI * i) / np;
      const px = cd * Math.cos(angle), py = cd * Math.sin(angle);
      const ppts = transformPts(planetResult.points, 0, px, py);
      writePoly(ppts, 'PLANET_GEAR');
      if (params.planetBore > 0) writeCircle(px, py, params.planetBore / 2, 'BORE');
    }
    // Carrier circle
    writeCircle(0, 0, cd, 'CARRIER');
    w('0');w('ENDSEC');w('0');w('EOF');
    return L.join('\n');
  }

  function generatePlanetarySVG() {
    const m = params.module, sz = params.sunTeeth, pz = params.planetTeeth, np = params.nPlanets;
    const rz = sz + 2 * pz, cd = m * (sz + pz) / 2;
    const outerR = ringResult.radii.root, margin = 5;
    const vw = 2 * (outerR + margin), vh = vw;
    const left = -(outerR + margin), top_ = -(outerR + margin);
    const ptsToD = pts => { let d = `M ${pts[0][0].toFixed(6)},${(-pts[0][1]).toFixed(6)}`; for (let i = 1; i < pts.length; i++) d += ` L ${pts[i][0].toFixed(6)},${(-pts[i][1]).toFixed(6)}`; return d + ' Z'; };
    let s = `<?xml version="1.0" encoding="UTF-8"?>\n<svg xmlns="http://www.w3.org/2000/svg" width="${vw.toFixed(2)}mm" height="${vh.toFixed(2)}mm" viewBox="${left.toFixed(4)} ${top_.toFixed(4)} ${vw.toFixed(4)} ${vh.toFixed(4)}">\n`;
    // Ring
    s += `<path d="${ptsToD(ringResult.points)}" fill="none" stroke="#e11d48" stroke-width="0.2"/>\n`;
    // Sun
    s += `<path d="${ptsToD(sunResult.points)}" fill="none" stroke="#f59e0b" stroke-width="0.2"/>\n`;
    if (params.sunBore > 0) s += `<circle cx="0" cy="0" r="${(params.sunBore / 2).toFixed(6)}" fill="none" stroke="#f59e0b" stroke-width="0.15"/>\n`;
    // Planets
    for (let i = 0; i < np; i++) {
      const angle = (2 * Math.PI * i) / np;
      const px = cd * Math.cos(angle), py = cd * Math.sin(angle);
      const ppts = transformPts(planetResult.points, 0, px, py);
      s += `<path d="${ptsToD(ppts)}" fill="none" stroke="#06b6d4" stroke-width="0.2"/>\n`;
      if (params.planetBore > 0) s += `<circle cx="${px.toFixed(6)}" cy="${(-py).toFixed(6)}" r="${(params.planetBore / 2).toFixed(6)}" fill="none" stroke="#06b6d4" stroke-width="0.15"/>\n`;
    }
    // Carrier
    s += `<circle cx="0" cy="0" r="${cd.toFixed(6)}" fill="none" stroke="#10b981" stroke-width="0.1" stroke-dasharray="1,1"/>\n`;
    // Pitch circles
    s += `<circle cx="0" cy="0" r="${sunResult.radii.pitch.toFixed(6)}" fill="none" stroke="#888" stroke-width="0.1" stroke-dasharray="1,1"/>\n`;
    s += `<circle cx="0" cy="0" r="${ringResult.radii.pitch.toFixed(6)}" fill="none" stroke="#888" stroke-width="0.1" stroke-dasharray="1,1"/>\n`;
    s += `</svg>`; return s;
  }

  function init() {
    Renderer.init($('#gearCanvas'));

    // Gear 1 controls
    bindCtl('#r-mod', '#n-mod', '#v-mod', v => v.toFixed(1));
    bindCtl('#r-teeth', '#n-teeth', '#v-teeth', v => String(Math.round(v)));
    bindCtl('#r-ps', '#n-ps', '#v-ps', v => v.toFixed(2));
    bindCtl('#r-bore', '#n-bore', '#v-bore', v => v.toFixed(1));
    bindCtl('#r-cl', '#n-cl', '#v-cl', v => v.toFixed(2));
    bindCtl('#r-res', '#n-res', '#v-res', v => String(Math.round(v)));
    $('#s-pa').addEventListener('change', updateGear);

    // Gear 2 controls
    bindCtl('#r-teeth2', '#n-teeth2', '#v-teeth2', v => String(Math.round(v)));
    bindCtl('#r-ps2', '#n-ps2', '#v-ps2', v => v.toFixed(2));
    bindCtl('#r-bore2', '#n-bore2', '#v-bore2', v => v.toFixed(1));

    // Planetary controls
    bindCtl('#r-sunz', '#n-sunz', '#v-sunz', v => String(Math.round(v)));
    bindCtl('#r-planz', '#n-planz', '#v-planz', v => String(Math.round(v)));
    bindCtl('#r-nplan', '#n-nplan', '#v-nplan', v => String(Math.round(v)));
    bindCtl('#r-sunbore', '#n-sunbore', '#v-sunbore', v => v.toFixed(1));
    bindCtl('#r-planbore', '#n-planbore', '#v-planbore', v => v.toFixed(1));

    // Mode switch
    $('#mode-single').addEventListener('click', () => setMode('single'));
    $('#mode-pair').addEventListener('click', () => setMode('pair'));
    $('#mode-planetary').addEventListener('click', () => setMode('planetary'));

    // Animation
    $('#btn-play').addEventListener('click', () => {
      if (Renderer.isPlaying()) { Renderer.pause(); updatePlayBtn(false); }
      else { Renderer.play(); updatePlayBtn(true); }
    });
    $('#r-speed').addEventListener('input', e => {
      const v = parseFloat(e.target.value);
      Renderer.setSpeed(v);
      $('#v-speed').textContent = v.toFixed(1) + 'x';
    });

    // Display toggles
    document.querySelectorAll('.toggle').forEach(el => {
      el.addEventListener('click', () => { el.classList.toggle('active'); Renderer.setDisplayOpt(el.dataset.key, el.classList.contains('active')); });
    });

    // Zoom
    $('#btn-zoomfit').addEventListener('click', () => Renderer.zoomToFit());
    $('#btn-zoomin').addEventListener('click', () => Renderer.zoomIn());
    $('#btn-zoomout').addEventListener('click', () => Renderer.zoomOut());

    // Exports
    $('#btn-dxf').addEventListener('click', () => {
      if (!result1 && !sunResult) return;
      toast('Generating DXF...');
      setTimeout(() => {
        if (planetaryMode && sunResult) {
          const dxf = generatePlanetaryDXF();
          dl(dxf, `planetary_s${params.sunTeeth}_p${params.planetTeeth}_m${params.module}.dxf`, 'application/dxf');
        } else if (pairMode && result2) {
          const cd = parseFloat($('#i-cd').textContent);
          const phase2 = Math.PI - Math.PI / params.teeth2;
          const g2t = transformPts(result2.points, phase2, cd, 0);
          const dxf = DXFExport.generate(result1.points, params.bore, result1.radii, g2t, params.bore2, result2.radii, cd);
          dl(dxf, `gears_z${params.teeth}_z${params.teeth2}_m${params.module}.dxf`, 'application/dxf');
        } else {
          const dxf = DXFExport.generate(result1.points, params.bore, result1.radii);
          dl(dxf, `gear_z${params.teeth}_m${params.module}.dxf`, 'application/dxf');
        }
        toast('DXF exported!');
      }, 30);
    });

    $('#btn-svg').addEventListener('click', () => {
      if (!result1 && !sunResult) return;
      toast('Generating SVG...');
      setTimeout(() => {
        if (planetaryMode && sunResult) {
          const svg = generatePlanetarySVG();
          dl(svg, `planetary_s${params.sunTeeth}_p${params.planetTeeth}_m${params.module}.svg`, 'image/svg+xml');
        } else if (pairMode && result2) {
          const cd = parseFloat($('#i-cd').textContent);
          const phase2 = Math.PI - Math.PI / params.teeth2;
          const g2t = transformPts(result2.points, phase2, cd, 0);
          const svg = SVGExport.generate(result1.points, params.bore, result1.radii, g2t, params.bore2, result2.radii, cd);
          dl(svg, `gears_z${params.teeth}_z${params.teeth2}_m${params.module}.svg`, 'image/svg+xml');
        } else {
          const svg = SVGExport.generate(result1.points, params.bore, result1.radii);
          dl(svg, `gear_z${params.teeth}_m${params.module}.svg`, 'image/svg+xml');
        }
        toast('SVG exported!');
      }, 30);
    });

    $('#btn-png').addEventListener('click', () => {
      if (!result1 && !sunResult) return;
      toast('Exporting PNG...');
      setTimeout(() => {
        Renderer.getCanvas().toBlob(blob => {
          let name;
          if (planetaryMode) name = `planetary_s${params.sunTeeth}_p${params.planetTeeth}_m${params.module}.png`;
          else if (pairMode) name = `gears_z${params.teeth}_z${params.teeth2}_m${params.module}.png`;
          else name = `gear_z${params.teeth}_m${params.module}.png`;
          dl(blob, name, 'image/png');
        });
      }, 30);
    });

    // Initial render
    updateGear();
    requestAnimationFrame(() => Renderer.zoomToFit());
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init); else init();
  if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js').catch(() => {});
})();
</script>
</body>
</html>